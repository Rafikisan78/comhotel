{
	"info": {
		"name": "ComHotel - Tests Manuels Recommand√©s",
		"description": "Collection de tests pour valider la fonctionnalit√© Email Confirmation + OWASP 2024",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "comhotel-tests-v1.6"
	},
	"item": [
		{
			"name": "1. Flux Complet Inscription + Email Confirmation",
			"description": "Tests du flux complet d'inscription avec confirmation email",
			"item": [
				{
					"name": "A. Inscription Nouvel Utilisateur",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('confirmation_sent_at est renseign√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.confirmation_sent_at).to.not.be.null;",
									"});",
									"",
									"pm.test('email_verified est false', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.user_metadata.email_verified).to.be.false;",
									"});",
									"",
									"// Sauvegarder l'ID utilisateur pour la confirmation automatique",
									"var jsonData = pm.response.json();",
									"pm.environment.set('USER_ID', jsonData.id);",
									"console.log('üíæ USER_ID sauvegard√©: ' + jsonData.id);",
									"",
									"console.log('‚úÖ Utilisateur cr√©√©. V√©rifiez votre bo√Æte mail pour le lien de confirmation.');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "apikey",
								"value": "{{SUPABASE_SERVICE_ROLE_KEY}}",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"nouveau.user@test.com\",\n  \"password\": \"NouveauPass123!\",\n  \"options\": {\n    \"data\": {\n      \"first_name\": \"Nouveau\",\n      \"last_name\": \"User\"\n    },\n    \"emailRedirectTo\": \"http://localhost:3000/auth/confirm\"\n  }\n}"
						},
						"url": {
							"raw": "{{SUPABASE_URL}}/auth/v1/signup",
							"host": ["{{SUPABASE_URL}}"],
							"path": ["auth", "v1", "signup"]
						},
						"description": "Cr√©er un nouvel utilisateur et d√©clencher l'envoi d'email de confirmation"
					},
					"response": []
				},
				{
					"name": "B. V√©rifier Statut Email (Non Confirm√©)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Email non confirm√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.confirmed).to.be.false;",
									"    pm.expect(jsonData.message).to.eql('Email non confirm√©');",
									"});",
									"",
									"console.log('‚è≥ Email en attente de confirmation');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"nouveau.user@test.com\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/email/check-status",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "email", "check-status"]
						},
						"description": "V√©rifier que l'email n'est pas encore confirm√©"
					},
					"response": []
				},
				{
					"name": "C. Confirmer Email via API Admin",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// R√©cup√©rer l'ID utilisateur depuis l'inscription (test A)",
									"// Pour cela, vous devez d'abord lister les users et trouver celui avec l'email",
									"console.log('üîç Recherche de l\\'ID utilisateur pour confirmation...');"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Email confirm√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.email_confirmed_at).to.not.be.null;",
									"});",
									"",
									"console.log('‚úÖ Email confirm√© automatiquement via API Admin');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "apikey",
								"value": "{{SUPABASE_SERVICE_ROLE_KEY}}",
								"type": "text"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{SUPABASE_SERVICE_ROLE_KEY}}",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email_confirm\": true\n}"
						},
						"url": {
							"raw": "{{SUPABASE_URL}}/auth/v1/admin/users/{{USER_ID}}",
							"host": ["{{SUPABASE_URL}}"],
							"path": ["auth", "v1", "admin", "users", "{{USER_ID}}"]
						},
						"description": "Confirmer l'email automatiquement via l'API Admin de Supabase (sans cliquer sur le lien)\n\n**IMPORTANT:** Vous devez d'abord d√©finir la variable {{USER_ID}} avec l'ID de l'utilisateur cr√©√© dans le test A.\n\nPour obtenir l'ID, vous pouvez:\n1. R√©cup√©rer l'ID depuis la r√©ponse du test A (field: id)\n2. OU utiliser le test 'Lister utilisateurs' pour trouver l'ID par email"
					},
					"response": []
				},
				{
					"name": "C-bis. ‚è∏Ô∏è ALTERNATIVE - Cliquer sur lien email",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "",
							"host": [""]
						},
						"description": "**ACTION MANUELLE ALTERNATIVE:**\n\nSi vous pr√©f√©rez tester le flux r√©el avec email:\n\n1. Ouvrir votre bo√Æte mail (nouveau.user@test.com)\n2. Trouver l'email de confirmation de Supabase\n3. Cliquer sur le lien de confirmation\n4. Une fois fait, passer au test D\n\n**NOTE:** Ce test est facultatif si vous utilisez le test C (API Admin)"
					},
					"response": []
				},
				{
					"name": "D. V√©rifier Statut Email (Confirm√©)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Email confirm√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.confirmed).to.be.true;",
									"    pm.expect(jsonData.message).to.eql('Email confirm√©');",
									"    pm.expect(jsonData.confirmedAt).to.not.be.null;",
									"});",
									"",
									"console.log('‚úÖ Email confirm√© avec succ√®s !');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"nouveau.user@test.com\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/email/check-status",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "email", "check-status"]
						},
						"description": "V√©rifier que l'email est maintenant confirm√©"
					},
					"response": []
				},
				{
					"name": "E. Cr√©er Utilisateur dans Table Users",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Utilisateur cr√©√© avec r√¥le guest', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.user).to.not.be.undefined;",
									"    pm.expect(jsonData.user.role).to.eql('guest');",
									"});",
									"",
									"pm.test('Access token re√ßu', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.accessToken).to.not.be.undefined;",
									"    pm.environment.set('ACCESS_TOKEN', jsonData.accessToken);",
									"    pm.environment.set('USER_TO_DELETE_ID', jsonData.user.id);",
									"});",
									"",
									"console.log('‚úÖ Utilisateur cr√©√© dans table users - Token sauvegard√© dans ACCESS_TOKEN');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"nouveau.user@test.com\",\n  \"password\": \"NouveauPass123!\",\n  \"firstName\": \"Nouveau\",\n  \"lastName\": \"User\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/register",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "register"]
						},
						"description": "Cr√©er l'utilisateur dans la table users APR√àS confirmation email.\n\n**IMPORTANT:** Ce endpoint doit √™tre appel√© APR√àS que l'email ait √©t√© confirm√© (tests C ou C-bis).\n\nCe test sauvegarde automatiquement:\n- ACCESS_TOKEN: Pour les tests n√©cessitant une authentification utilisateur\n- USER_TO_DELETE_ID: Pour les tests de suppression"
					},
					"response": []
				},
				{
					"name": "F. Login Utilisateur Guest",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('R√¥le guest confirm√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.user.role).to.eql('guest');",
									"});",
									"",
									"pm.test('Access token re√ßu', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.accessToken).to.not.be.undefined;",
									"    pm.environment.set('ACCESS_TOKEN', jsonData.accessToken);",
									"    pm.environment.set('USER_ID', jsonData.user.id);",
									"});",
									"",
									"console.log('‚úÖ Login guest r√©ussi - Token sauvegard√© dans ACCESS_TOKEN');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"nouveau.user@test.com\",\n  \"password\": \"NouveauPass123!\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/login",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "login"]
						},
						"description": "Connexion avec un compte utilisateur normal (guest).\n\nCe test valide:\n- La connexion apr√®s confirmation email\n- L'attribution correcte du r√¥le guest\n- La g√©n√©ration du JWT"
					},
					"response": []
				}
			]
		},
		{
			"name": "2. Tests Politique OWASP 2024",
			"description": "Valider la nouvelle politique de mot de passe",
			"item": [
				{
					"name": "G. ‚ùå Mot de Passe Trop Court",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 400 Bad Request', function () {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"pm.test('Message erreur contient \"12 caract√®res\"', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.message).to.include('12 caract√®res');",
									"});",
									"",
									"console.log('‚úÖ Validation longueur minimum fonctionne');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"test.court@test.com\",\n  \"password\": \"Short123!\",\n  \"firstName\": \"Test\",\n  \"lastName\": \"Court\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/register",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "register"]
						},
						"description": "Mot de passe de 10 caract√®res (< 12) - doit √©chouer"
					},
					"response": []
				},
				{
					"name": "H. ‚ùå Mot de Passe Sans Majuscule",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 400 Bad Request', function () {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"pm.test('Message erreur contient \"majuscule\"', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.message.toLowerCase()).to.include('majuscule');",
									"});",
									"",
									"console.log('‚úÖ Validation majuscule fonctionne');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"test.minuscule@test.com\",\n  \"password\": \"minuscule123!\",\n  \"firstName\": \"Test\",\n  \"lastName\": \"Minuscule\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/register",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "register"]
						},
						"description": "Mot de passe sans majuscule - doit √©chouer"
					},
					"response": []
				},
				{
					"name": "I. ‚ùå Mot de Passe Sans Chiffre",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 400 Bad Request', function () {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"pm.test('Message erreur contient \"chiffre\"', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.message.toLowerCase()).to.include('chiffre');",
									"});",
									"",
									"console.log('‚úÖ Validation chiffre fonctionne');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"test.sanchiffre@test.com\",\n  \"password\": \"MotDePasseSecure!\",\n  \"firstName\": \"Test\",\n  \"lastName\": \"SansChiffre\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/register",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "register"]
						},
						"description": "Mot de passe sans chiffre - doit √©chouer"
					},
					"response": []
				},
				{
					"name": "J. ‚ùå Mot de Passe Sans Caract√®re Sp√©cial",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 400 Bad Request', function () {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"pm.test('Message erreur contient \"sp√©cial\"', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.message.toLowerCase()).to.include('sp√©cial');",
									"});",
									"",
									"console.log('‚úÖ Validation caract√®re sp√©cial fonctionne');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"test.sanspecial@test.com\",\n  \"password\": \"MotDePasse123\",\n  \"firstName\": \"Test\",\n  \"lastName\": \"SansSpecial\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/register",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "register"]
						},
						"description": "Mot de passe sans caract√®re sp√©cial - doit √©chouer"
					},
					"response": []
				},
				{
					"name": "K. ‚úÖ Mot de Passe OWASP Valide",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 201 Created', function () {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test('Utilisateur cr√©√© avec role guest', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.user.role).to.eql('guest');",
									"});",
									"",
									"pm.test('AccessToken g√©n√©r√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.accessToken).to.not.be.null;",
									"});",
									"",
									"console.log('‚úÖ Mot de passe OWASP 2024 valide accept√©');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"test.valide@test.com\",\n  \"password\": \"ValidPass123!\",\n  \"firstName\": \"Test\",\n  \"lastName\": \"Valide\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/register",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "register"]
						},
						"description": "Mot de passe conforme OWASP 2024 - doit r√©ussir"
					},
					"response": []
				}
			]
		},
		{
			"name": "3. Test Renvoi Email",
			"description": "Tests de la fonctionnalit√© resend email",
			"item": [
				{
					"name": "L. Resend Email de Confirmation",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Message de succ√®s', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.message).to.include('Email de confirmation renvoy√©');",
									"});",
									"",
									"console.log('‚úÖ Email de confirmation renvoy√©. V√©rifiez votre bo√Æte mail.');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"nouveau.user@test.com\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/email/resend",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "email", "resend"]
						},
						"description": "Renvoyer l'email de confirmation"
					},
					"response": []
				},
				{
					"name": "M. Resend Rate Limit (1/minute)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Ce test peut r√©ussir (200) ou √™tre rate limited (400)",
									"// selon le timing par rapport au test pr√©c√©dent",
									"pm.test('Status 200 ou 400', function () {",
									"    pm.expect([200, 400]).to.include(pm.response.code);",
									"});",
									"",
									"if (pm.response.code === 400) {",
									"    console.log('‚è±Ô∏è Rate limit atteint (normal si < 1 minute depuis dernier resend)');",
									"} else {",
									"    console.log('‚úÖ Resend autoris√© (> 1 minute depuis dernier resend)');",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"nouveau.user@test.com\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/email/resend",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "email", "resend"]
						},
						"description": "Tester le rate limiting (1/minute)"
					},
					"response": []
				}
			]
		},
		{
			"name": "4. Tests S√©curit√©",
			"description": "Validation des protections de s√©curit√©",
			"item": [
				{
					"name": "N. ‚ùå Injection de R√¥le Admin",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 201 Created', function () {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test('R√¥le forc√© √† guest (pas admin)', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.user.role).to.eql('guest');",
									"    pm.expect(jsonData.user.role).to.not.eql('admin');",
									"});",
									"",
									"console.log('‚úÖ Protection injection de r√¥le fonctionne - R√¥le forc√© √† guest');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"hacker@test.com\",\n  \"password\": \"HackerPass123!\",\n  \"firstName\": \"Hacker\",\n  \"lastName\": \"Test\",\n  \"role\": \"admin\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/register",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "register"]
						},
						"description": "Tenter de s'auto-attribuer le r√¥le admin - doit √™tre forc√© √† guest"
					},
					"response": []
				},
				{
					"name": "O. Login Sans Email Confirm√©",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"// Le comportement d√©pend de la configuration Supabase",
									"// Par d√©faut, Supabase peut autoriser le login m√™me sans confirmation",
									"pm.test('Status code re√ßu', function () {",
									"    pm.expect([200, 400, 401]).to.include(pm.response.code);",
									"});",
									"",
									"if (pm.response.code === 200) {",
									"    console.log('‚ÑπÔ∏è Login autoris√© sans confirmation (config Supabase par d√©faut)');",
									"    var jsonData = pm.response.json();",
									"    pm.test('email_confirmed_at est null', function() {",
									"        pm.expect(jsonData.user.email_confirmed_at).to.be.null;",
									"    });",
									"} else {",
									"    console.log('‚úÖ Login bloqu√© sans confirmation email');",
									"}"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"// D'abord cr√©er un utilisateur sans confirmer l'email",
									"// Puis essayer de se connecter"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "apikey",
								"value": "{{SUPABASE_SERVICE_ROLE_KEY}}",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"nonconfirme@test.com\",\n  \"password\": \"NonConfirme123!\"\n}"
						},
						"url": {
							"raw": "{{SUPABASE_URL}}/auth/v1/token?grant_type=password",
							"host": ["{{SUPABASE_URL}}"],
							"path": ["auth", "v1", "token"],
							"query": [
								{
									"key": "grant_type",
									"value": "password"
								}
							]
						},
						"description": "Tester le login sans avoir confirm√© l'email"
					},
					"response": []
				}
			]
		},
		{
			"name": "5. Tests CRUD Utilisateurs",
			"description": "Tests des op√©rations CRUD existantes",
			"item": [
				{
					"name": "P. Mise √† Jour Utilisateur",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('T√©l√©phone mis √† jour', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.phone).to.eql('0712345678');",
									"});",
									"",
									"pm.test('updatedAt modifi√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.updatedAt).to.not.be.null;",
									"});",
									"",
									"console.log('‚úÖ Mise √† jour utilisateur r√©ussie');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "PATCH",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{ACCESS_TOKEN}}",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"phone\": \"0712345678\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/users/{{USER_ID}}",
							"host": ["{{BACKEND_URL}}"],
							"path": ["users", "{{USER_ID}}"]
						},
						"description": "Mettre √† jour le t√©l√©phone d'un utilisateur"
					},
					"response": []
				},
				{
					"name": "Q. Soft Delete Utilisateur (Admin)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('deletedAt renseign√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.deletedAt).to.not.be.null;",
									"});",
									"",
									"pm.test('deletedBy renseign√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.deletedBy).to.not.be.null;",
									"});",
									"",
									"console.log('‚úÖ Soft delete r√©ussi');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "DELETE",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{ADMIN_ACCESS_TOKEN}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{BACKEND_URL}}/users/{{USER_TO_DELETE_ID}}",
							"host": ["{{BACKEND_URL}}"],
							"path": ["users", "{{USER_TO_DELETE_ID}}"]
						},
						"description": "Soft delete d'un utilisateur (admin uniquement)"
					},
					"response": []
				},
				{
					"name": "R. Restauration Utilisateur",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('deletedAt remis √† null', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.deletedAt).to.be.undefined;",
									"});",
									"",
									"pm.test('deletedBy remis √† null', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.deletedBy).to.be.undefined;",
									"});",
									"",
									"console.log('‚úÖ Restauration r√©ussie');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{ADMIN_ACCESS_TOKEN}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{BACKEND_URL}}/users/{{USER_TO_DELETE_ID}}/restore",
							"host": ["{{BACKEND_URL}}"],
							"path": ["users", "{{USER_TO_DELETE_ID}}", "restore"]
						},
						"description": "Restaurer un utilisateur soft-deleted"
					},
					"response": []
				}
			]
		},
		{
			"name": "6. Tests Administration",
			"description": "Tests des fonctionnalit√©s d'administration",
			"item": [
				{
					"name": "A. Login Admin",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('R√¥le admin confirm√©', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.user.role).to.eql('admin');",
									"});",
									"",
									"pm.test('Access token re√ßu', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.accessToken).to.not.be.undefined;",
									"    pm.environment.set('ADMIN_ACCESS_TOKEN', jsonData.accessToken);",
									"    pm.environment.set('ADMIN_USER_ID', jsonData.user.id);",
									"});",
									"",
									"console.log('‚úÖ Login admin r√©ussi - Token sauvegard√© dans ADMIN_ACCESS_TOKEN');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"email\": \"rfateh@gmail.com\",\n  \"password\": \"AdminSecure2026!@\"\n}"
						},
						"url": {
							"raw": "{{BACKEND_URL}}/auth/login",
							"host": ["{{BACKEND_URL}}"],
							"path": ["auth", "login"]
						},
						"description": "Connexion avec un compte administrateur"
					},
					"response": []
				},
				{
					"name": "B. Liste Tous Utilisateurs (Admin)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test('Status 200 OK', function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test('Liste non vide', function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData.length).to.be.greaterThan(0);",
									"});",
									"",
									"pm.test('Contient utilisateurs supprim√©s', function () {",
									"    var jsonData = pm.response.json();",
									"    var deletedUsers = jsonData.filter(u => u.deletedAt !== null && u.deletedAt !== undefined);",
									"    console.log('Utilisateurs supprim√©s trouv√©s: ' + deletedUsers.length);",
									"});",
									"",
									"pm.test('Affiche tous les r√¥les (admin, guest, hotel_owner)', function () {",
									"    var jsonData = pm.response.json();",
									"    var roles = [...new Set(jsonData.map(u => u.role))];",
									"    console.log('R√¥les trouv√©s: ' + roles.join(', '));",
									"});",
									"",
									"console.log('‚úÖ Liste compl√®te r√©cup√©r√©e - Total: ' + pm.response.json().length + ' utilisateurs');"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{ADMIN_ACCESS_TOKEN}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{BACKEND_URL}}/users/admin/all",
							"host": ["{{BACKEND_URL}}"],
							"path": ["users", "admin", "all"]
						},
						"description": "R√©cup√©rer la liste compl√®te de tous les utilisateurs (incluant les supprim√©s) - R√©serv√© aux admins"
					},
					"response": []
				}
			]
		}
	],
	"variable": []
}
